<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oaxsun PDF Compressor (v0.1)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 920px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; box-shadow: 0 1px 8px rgba(0,0,0,.04); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .muted { color: #6b7280; }
    label { font-weight: 600; }
    input[type=file] { padding: 10px; border: 1px dashed #d1d5db; border-radius: 12px; width: 100%; }
    select, button { padding: 10px 12px; border-radius: 12px; border: 1px solid #d1d5db; background: white; }
    button { cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .log { white-space: pre-wrap; background: #0b1220; color: #e5e7eb; padding: 12px; border-radius: 12px; font-size: 13px; }
    .pill { display: inline-block; padding: 3px 10px; border-radius: 999px; background: #f3f4f6; }
  </style>
</head>
<body>
  <h1>Compresor de PDF — Oaxsun (v0.1)</h1>
  <p class="muted">Sube un PDF (máx <b>200 MiB</b>), elige nivel y descarga el resultado.</p>

  <div class="card">
    <div class="row" style="margin-bottom: 10px;">
      <div style="flex: 1 1 320px;">
        <label for="file">PDF</label>
        <input id="file" type="file" accept="application/pdf" />
        <div class="muted" id="fileInfo" style="margin-top:6px;"></div>
      </div>

      <div>
        <label for="level">Nivel</label><br/>
        <select id="level">
          <option value="high">Alta (mejor calidad)</option>
          <option value="medium" selected>Recomendada</option>
          <option value="low">Máxima (más pequeño)</option>
        </select>
      </div>

      <div style="align-self:flex-end;">
        <button id="start">Comprimir</button>
      </div>
    </div>

    <div class="row" style="gap: 10px; margin-top: 8px;">
      <span class="pill" id="status">status: idle</span>
      <span class="pill" id="sizes">—</span>
      <span class="pill" id="ratio">—</span>
      <a id="download" href="#" style="display:none;">Descargar</a>
    </div>

    <h3 style="margin-top: 16px;">Logs</h3>
    <div class="log" id="log">Listo.</div>
  </div>

<script>
  const fileEl = document.getElementById('file');
  const levelEl = document.getElementById('level');
  const startBtn = document.getElementById('start');
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const sizesEl = document.getElementById('sizes');
  const ratioEl = document.getElementById('ratio');
  const dlEl = document.getElementById('download');
  const fileInfoEl = document.getElementById('fileInfo');

  const MAX = 200 * 1024 * 1024; // 200 MiB

  function bytes(n){
    if (n === null || n === undefined) return '—';
    const units = ['B','KB','MB','GB'];
    let i=0, x=n;
    while (x >= 1024 && i < units.length-1){ x/=1024; i++; }
    return `${x.toFixed(i===0?0:1)} ${units[i]}`;
  }

  function log(msg){
    logEl.textContent = `${new Date().toLocaleTimeString()}  ${msg}\n` + logEl.textContent;
  }

  fileEl.addEventListener('change', () => {
    dlEl.style.display = 'none';
    dlEl.href = '#';
    statusEl.textContent = 'status: idle';
    sizesEl.textContent = '—';
    ratioEl.textContent = '—';
    const f = fileEl.files?.[0];
    if (!f) { fileInfoEl.textContent=''; return; }
    fileInfoEl.textContent = `Archivo: ${f.name} — ${bytes(f.size)}`;
    if (f.size > MAX){
      fileInfoEl.textContent += '  (EXCEDE 200 MiB)';
    }
  });

  async function poll(jobId){
    for(;;){
      const r = await fetch(`/jobs/${jobId}`);
      const j = await r.json();
      statusEl.textContent = `status: ${j.status}`;
      sizesEl.textContent = `original: ${bytes(j.input_bytes)} → final: ${bytes(j.output_bytes)}`;
      ratioEl.textContent = (j.ratio ? `ratio: ${(j.ratio*100).toFixed(1)}%` : '—');

      if (j.status === 'done'){
        dlEl.href = `/jobs/${jobId}/download`;
        dlEl.style.display = 'inline-block';
        log(`Listo. Descarga disponible.`);
        startBtn.disabled = false;
        return;
      }
      if (j.status === 'failed'){
        log(`Falló: ${j.error || 'error desconocido'}`);
        startBtn.disabled = false;
        return;
      }
      await new Promise(res => setTimeout(res, 900));
    }
  }

  startBtn.addEventListener('click', async () => {
    const f = fileEl.files?.[0];
    if (!f){
      alert('Selecciona un PDF');
      return;
    }
    if (f.size > MAX){
      alert('El archivo excede 200 MiB');
      return;
    }

    startBtn.disabled = true;
    dlEl.style.display = 'none';
    statusEl.textContent = 'status: uploading';
    log(`Subiendo ${f.name} (${bytes(f.size)})...`);

    const fd = new FormData();
    fd.append('file', f);
    fd.append('level', levelEl.value);

    const resp = await fetch('/pdf/compress', { method: 'POST', body: fd });
    if (!resp.ok){
      const err = await resp.text();
      log(`Error al subir: ${resp.status} ${err}`);
      statusEl.textContent = 'status: error';
      startBtn.disabled = false;
      return;
    }
    const { job_id } = await resp.json();
    log(`Job creado: ${job_id}. Procesando...`);
    statusEl.textContent = 'status: queued';
    await poll(job_id);
  });
</script>
</body>
</html>
